// ================================================================
// Archivo: prisma/schema.prisma
// ================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================== ENUMS =====================

enum Role {
  ADMIN
  DIRECTOR
  SUPERVISOR
  RESIDENTE
  VISITANTE
}

enum BitacoraEstado {
  ABIERTA
  CERRADA
}

enum BitacoraVariable {
  SE_INICIA
  SE_AUTORIZA
  SE_RECOMIENDA
  SE_SOLICITA
  SE_VALIDA
  PRODUCTO_NO_CONFORME
}

enum EstadoObra {
  PENDIENTE
  EN_PROGRESO
  FINALIZADA
  PAUSADA
  CANCELADA
}

enum EstadoActividad {
  CUMPLE
  NO_CUMPLE
  NO_APLICA
}

enum EstadoOT {
  PENDIENTE
  EN_PROCESO
  FINALIZADA
  CANCELADA
  APROBADA
  RECHAZADA
}

// ===================== MODELOS =====================

// üåü VARIABLES (Cat√°logo)
model Variable {
  id            Int      @id @default(autoincrement())
  nombre        String   @unique
  observaciones String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  bitacoras Bitacora[]

  @@map("variables")
}

// üåü UNIDADES (Cat√°logo)
model Unidad {
  id            Int      @id @default(autoincrement())
  nombre        String   @unique
  observaciones String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  bitacoras Bitacora[] @relation("BitacoraUnidad")
}

// üåü MEDICIONES (Cat√°logo)
model Medicion {
  id            Int      @id @default(autoincrement())
  nombre        String   @unique
  observaciones String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  bitacoras Bitacora[]

  @@map("mediciones")
}

// üöÄ CONTRATISTAS
model Contratista {
  id            Int      @id @default(autoincrement())
  nombre        String   @unique
  responsable   String?
  email         String?
  observaciones String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaci√≥n con Director (User)
  directorId Int?
  director   User? @relation(fields: [directorId], references: [id])

  bitacoras Bitacora[]

  @@map("contratistas")
}

// üöÄ USERS
model User {
  id             Int      @id @default(autoincrement())
  username       String   @unique
  hash           String
  nombreCompleto String
  email          String?  @unique
  phone          String?  @unique
  role           Role     @default(RESIDENTE)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relaciones existentes
  bitacoras      Bitacora[]     @relation("BitacoraResponsable")
  ordenesTrabajo OrdenTrabajo[]
  obras          Obra[]         @relation("ObraResponsables")
  createdObras   Obra[]         @relation("CreatedObras")

  // Relaci√≥n: Un Director puede tener muchos contratistas
  contratistas Contratista[]

  // Relaci√≥n: Obras dirigidas por un Director
  obrasDirigidas Obra[] @relation("DirectorObras")

  // Relaci√≥n: Jerarqu√≠a de usuarios (Director -> Sus usuarios)
  ownerDirectorId Int?
  ownerDirector   User?  @relation("DirectorUsers", fields: [ownerDirectorId], references: [id])
  subUsers        User[] @relation("DirectorUsers")

  // L√≠mites SaaS (Esto es lo que faltaba en la DB)
  maxUsers Int? @default(3)
  maxObras Int? @default(1)
}

// üöÄ OBRAS
model Obra {
  id               Int        @id @default(autoincrement())
  prefijo          String     @unique
  nombre           String     @unique
  descripcion      String?
  observaciones    String?
  estado           EstadoObra @default(PENDIENTE)
  fechaInicio      DateTime?
  fechaFinPrevista DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  responsables User[] @relation("ObraResponsables")

  bitacoras Bitacora[]
  ordenes   OrdenTrabajo[]

  creatorId Int
  creator   User @relation("CreatedObras", fields: [creatorId], references: [id])

  // Relaci√≥n con Director
  directorId Int?
  director   User? @relation("DirectorObras", fields: [directorId], references: [id])
}

// üöÄ BIT√ÅCORAS
model Bitacora {
  id             Int            @id @default(autoincrement())
  codigo         String?        // üî• NUEVO CAMPO (nullable para registros viejos)
  obraId         Int
  responsableId  Int
  estado         BitacoraEstado @default(ABIERTA)
  fechaCreacion  DateTime       @default(now())
  fechaMejora    DateTime?
  fechaEjecucion DateTime?
  ubicacion      String?
  registro       String?
  unidad         String?
  observaciones  String?
  seguimiento    String?
  contratistaId  Int?
  latitud        Float?
  longitud       Float?

  variableId Int?
  variable   Variable? @relation(fields: [variableId], references: [id])

  medicionId Int?
  medicion   Medicion? @relation(fields: [medicionId], references: [id])

  unidadId  Int?
  unidadRel Unidad? @relation("BitacoraUnidad", fields: [unidadId], references: [id])

  obra        Obra         @relation(fields: [obraId], references: [id])
  responsable User         @relation("BitacoraResponsable", fields: [responsableId], references: [id])
  contratista Contratista? @relation(fields: [contratistaId], references: [id])

  evidencias            BitacoraMedia[]
  evidenciasSeguimiento BitacoraSeguimientoMedia[]

  @@index([obraId])
  @@index([responsableId])
  @@index([estado])
  @@index([fechaCreacion])
  @@index([contratistaId])
  @@index([latitud])
  @@index([longitud])
  @@index([variableId])
  @@index([medicionId])
  @@index([unidadId])
}

// üñºÔ∏è FOTOS NORMALES
model BitacoraMedia {
  id         Int      @id @default(autoincrement())
  bitacoraId Int
  url        String
  tipo       String
  metadata   Json?
  createdAt  DateTime @default(now())

  bitacora Bitacora @relation(fields: [bitacoraId], references: [id])
}

// üñºÔ∏è FOTOS DE SEGUIMIENTO
model BitacoraSeguimientoMedia {
  id         Int      @id @default(autoincrement())
  bitacoraId Int
  url        String
  tipo       String
  createdAt  DateTime @default(now())

  bitacora Bitacora @relation(fields: [bitacoraId], references: [id])
}

// üöÄ ORDEN DE TRABAJO
model OrdenTrabajo {
  id              Int              @id @default(autoincrement())
  nOrden          String           @unique
  identificacion  String?
  objetivo        String
  tipoTrabajo     String
  fecha           DateTime         @default(now())
  numeroAuto      String?
  observaciones   String?
  carpeta         String?
  actividad       String?
  estadoActividad EstadoActividad?
  estado          EstadoOT         @default(PENDIENTE)

  obraId Int
  obra   Obra @relation(fields: [obraId], references: [id], onDelete: Cascade)

  responsableId Int
  responsable   User @relation(fields: [responsableId], references: [id])

  carpetas Carpeta[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ordenes_trabajo")
}

model Carpeta {
  id             Int       @id @default(autoincrement())
  ordenTrabajoId Int
  nombre         String
  indice         Int
  actividades    Actividad[]

  ordenTrabajo OrdenTrabajo @relation(fields: [ordenTrabajoId], references: [id])

  @@map("carpetas")
}

model Actividad {
  id           Int        @id @default(autoincrement())
  carpetaId    Int
  nombre       String
  indice       Int
  evaluaciones EvaluacionActividad[]
  evidencias   ActividadMedia[]

  carpeta Carpeta @relation(fields: [carpetaId], references: [id])

  @@map("actividades")
}

model EvaluacionActividad {
  id            Int             @id @default(autoincrement())
  actividadId   Int
  estado        EstadoActividad
  observaciones String?
  createdAt     DateTime        @default(now())

  actividad Actividad @relation(fields: [actividadId], references: [id])

  @@map("evaluaciones_actividad")
}

model ActividadMedia {
  id          Int       @id @default(autoincrement())
  actividadId Int
  url         String
  tipo        String?
  metadata    Json?
  actividad   Actividad @relation(fields: [actividadId], references: [id])

  @@map("actividad_media")
}
